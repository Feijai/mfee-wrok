<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/app.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="js/slotmachine_v2.js"></script>
    <link rel="shortcut icon" href="#">
    <!-- <script src="http://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> -->
    <style>
        .panel {
            width: 1225px;
        }

        img {
            width: 230px;
            height: 230px;
        }

        .slotwrapper {

            width: 1155px;
            height: 690px;
            border: 1px solid black;
            ;
        }

        canvas {
            position: absolute;
            top: 13px;
            left: 30px;
        }
    </style>
</head>

<body>
    <div class="panel panel-primary container" style="position: relative;">

        <div id="main" class="panel-body ">
           
            <div class="slotwrapper">
                <ul class="ring" id="ring1" style="top:0px">
                </ul>
                <ul class="ring" id="ring2" style="top:0px">
                </ul>
                <ul class="ring" id="ring3" style="top:0px">
                </ul>
                <ul class="ring" id="ring4" style="top:0px">
                </ul>
                <ul class="ring" id="ring5" style="top:0px">
                </ul>
            </div>

            <div>
                <button v-on:click="handleBet" type="button" class="btn btn-success btn-lg" id="btn">開始</button>
            </div>
            <p id="result">{{userwallet}}</p>
            <button class="btn btn-success btn-lg" id="less">-</button>
            <input id="bet" type="text" placeholder="1" value="10">
            <button class="btn btn-success btn-lg" id="add">+</button>
            本局贏得獎金<span id="jackpot">0</span>
            <div>
                <button v-on:click="handleResult" type="button" class="btn btn-primary btn-lg" id="btn">遊戲結果</button>
            </div>
        </div>
        <canvas id="myCanvas"></canvas>
        <audio loop id="ingSound" src="./sounds/sloting.mp3" preload="metadata"></audio>
        <audio id="endSound" src="./sounds/slotend.mp3" preload="metadata"></audio>
        <audio id="winSound" src="./sounds/win.mp3" preload="metadata"></audio>
    </div>

    <script>
        
        var vueMain = new Vue({
            el: '#main',
            data: {
                testData: "OK",
                userwallet: 0
            },
            created: function () {
                $.ajax({
                    type: "get",
                    url: "http://localhost:3001/tiger/user",
                    success: function (res) {
                        vueMain.userwallet = JSON.parse(res)[0].UserWallet
                        // console.log(JSON.parse(res).UserWallet)
                    }
                });
            },
            methods: {
                handleBet: function () {
                    slotR = [];
                    var score = parseFloat($("#result").text()).toFixed(2);
                    var bet = parseFloat($('#bet').val());
                    var scoreBefore = 0
                    var winCount = 0;
                    bettime=new Date().toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'});;
                    //console.log(bet)

                    if (score < bet) {
                        $("#btn").attr("disabled", true);
                        alert("You don't have enough money")
                    } else {
                        score -= bet;
                        $("#result").text(score.toFixed(2));

                        $("#btn").attr("disabled", true);
                        $('.slotwrapper ul').playSpin();
                        ingSound.play();
                        let userwallet = parseFloat($("#result").text());
                        console.log("start:" + userwallet)
                        $.ajax({
                            type: "put",
                            url: "http://localhost:3001/tiger/user",
                            data: {
                                UserWallet: userwallet
                            }
                        });
                    }
                },
                handleResult(){
                    location.href="results.html";
                    
                }
            }
        })
        
        var ary = [
            ['cherry', 'orange', 'grape', 'cookie', 'bell', 'bar', '777'],
            ['orange', 'grape', 'cherry', 'cookie', '777', 'bell', 'bar'],
            ['cookie', 'cherry', 'orange', '777', 'bar', 'grape', 'bell'],
            ['grape', 'orange', 'bell', 'bar', 'cherry', '777', 'cookie'],
            ['bell', 'grape', 'cookie', '777', 'orange', 'bar', 'cherry']
        ]
        var tempcss = document.querySelectorAll('.ring');
        var slotR = [];
        var count = 0;
        var finCount = 0;
        var temp = 0;
        // var slotresult=document.getElementById('slotresult');
        var rwdW = parseInt($('.slotwrapper').css("width"));
        var rwdH = parseInt($('.slotwrapper').css("height"))
        $('#myCanvas').attr("width", rwdW);
        $('#myCanvas').attr("height", rwdH)
        var ctx = myCanvas.getContext("2d");
        $('#less').on('click', function () {
            var bet = parseFloat($("#bet").val());
            if (bet <= 1) {
                $("#less").removeAttr("disabled");
            } else {
                bet -= 1;
                $('#bet').val(bet.toFixed(2))
            }
        })
        $('#add').on('click', function () {
            var bet = parseFloat($("#bet").val());
            if (bet >= 10) {
                $("#add").removeAttr("disabled");
            } else {
                bet += 1;
                $('#bet').val(bet.toFixed(2))
            }
        })

        function resultIndex(count, ary) {

            for (j = 0; j <= 10; j += 5) {
                for (i = 1; i <= 5; i++) {
                    //for(k=0;k<3;k++){
                    count[j + i - 1] = ary[i - 1];
                }
            }
            for (i = 5; i < 10; i++) {

                count[i] = ((count[i] + 1) % 7);

            }
            for (i = 10; i < 15; i++) {

                count[i] = ((count[i] + 2) % 7);

            }
            for (i = 0; i < 15; i++) {
                count[i] = count[i] % 7;
            }
            return count;
        }
    //    screenshot();
        // $('#btn').on('click', function () {
            // slotR = [];
            // var score = parseFloat($("#result").text()).toFixed(2);
            // var bet = parseFloat($('#bet').val());
            // var scoreBefore = 0
            // var winCount = 0;
            // //console.log(bet)

            // if (score < bet) {
            //     $("#btn").attr("disabled", true);
            //     alert("You don't have enough money")
            // } else {
            //     score -= bet;
            //     $("#result").text(score.toFixed(2));

            //     $("#btn").attr("disabled", true);
            //     $('.slotwrapper ul').playSpin();
            //     ingSound.play();
            // }
        // });
        //將遊戲結果截圖
        // function screenshot() {
        //     html2canvas(document.getElementById('#slotresult')).then(function (canvas) {
        //         // document.body.appendChild(canvas);
              
        //         a= canvas.toDataURL("image/jpeg",0.2)
        //        af.setAttribute("src",a)
        //       console.log(a);
        //     });
            
        // }
        //將圖片轉由base64轉blob
        // function dataURLtoBlob(dataURI) {
        //     // convert base64/URLEncoded data component to raw binary data held in a string
        //     var byteString;
        //     if (dataURI.split(',')[0].indexOf('base64') >= 0)
        //         byteString = atob(dataURI.split(',')[1]);
        //     else
        //         byteString = unescape(dataURI.split(',')[1]);

        //     // separate out the mime component
        //     var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

        //     // write the bytes of the string to a typed array
        //     var ia = new Uint8Array(byteString.length);
        //     for (var i = 0; i < byteString.length; i++) {
        //         ia[i] = byteString.charCodeAt(i);
        //     }

        //     return new Blob([ia], { type: mimeString });
        // }
        creatRing1 = function () {
            var rings = document.querySelectorAll('.ring');
            //console.log($('#ring1'))
            for (var i = 0; i < 5; i++) {
                for (var j = 0; j < 7; j++) {
                    $(rings[i]).append('<li><img src="./img/' + ary[i][j] + '.png" /></li>')
                }
            }
        };
        creatRing1();
    </script>
    <script src="./js/resultLine.js"></script>
    <script src="./js/bonuscacl.js"></script>

</body>

</html>